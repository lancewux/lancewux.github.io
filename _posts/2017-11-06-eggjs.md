<h1 align="center"> egg.js </h1>

cluster
-

一个nodejs的实例运行在一个单线程中。为了利用系统的多核资源，nodejs提供了cluster模块。使用cluster模块可以很容易地创建共享服务端口号的多个子进程。

cluster包括一个master父进程和多个worker子进程。worker子进程用child_process.fork() 创建，所以父子进程间可以通过ipc channel进程通信。cluster支持两种分发请求的方法，一种是 round-robin，另一种是分发给有兴趣的worker进程。worker进程间是相互独立的，只要有一个worker还活着，服务器就会继续接受并处理请求。cluster并不管理worker进程的数量。

cluster实现worker子进程共享socket端口号的原理是。nodejs初始化会根据环境变量来判断是否为cluster模块fork出的worker进程，从而分别执行workerInit()和masterInit()函数来初始化环境。workerInit()的listen方法会调用cluster._getServer方法，该方法会进程判断，若master进程是第一次接收此端口号的worker，则申请一个内部TCP服务器来承担监听该端口的职责，同时hack掉listen方法里实现监听端口功能的部分。master进程会监听TCP服务器的connection事件，挑选出一个worker进程并发送newconn内部消息，把请求交由该worker进程处理。

egg-cluster
-

egg-cluster包括一个master进程、一个agent worker进程和多个app worker进程。agent worker使用child_process.fork() 创建，而app worker用cluster.fork()创建。

处理进程的异常退出，监听'uncaughtException'事件，使进程优雅地退出，


