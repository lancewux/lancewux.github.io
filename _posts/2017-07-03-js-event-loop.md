Javascript 单线程和异步
=

作为浏览器脚本语言，JavaScript的主要用途是与用户互动，以及操作DOM。这决定了它只能是单线程，否则会带来很复杂的同步问题。比如，假定JavaScript同时有两个线程，一个线程在某个DOM节点上添加内容，另一个线程删除了这个节点，这时浏览器应该以哪个线程为准？

为了利用多核CPU的计算能力，HTML5提出WebWorker标准，允许JavaScript脚本创建多个线程，但是子线程完全受主线程控制，且不得操作DOM。所以，这个新标准并没有改变JavaScript单线程的本质。

js选择了成为单线程的语言，所以它本身不可能是异步的，但js的宿主环境（比如浏览器，Node）是多线程的，宿主环境通过某种方式（事件驱动）使得js具备了异步的属性。

任务（回调）队列
-

js是单线程语言，浏览器只分配给js一个主线程，同时分配堆（heap）和栈（stack），用来执行任务（函数）。js线程运行时，一次把同步任务（synchronous）压入执行栈中，依次执行，比如&lt;script&gt;标签内的同步语句和函数。

执行栈中的代码在执行时，会调用webAPIs来发出异步任务请求，这些任务主要包括网络请求，定时器和事件监听等，浏览器会为其分配对应的线程来处理这些任务，比如http请求线程，浏览器定时触发器线程，浏览器事件触发线程。当这些线程执行完任务时，就会往回调队列中添加一个事件。

当执行栈中的代码执行完毕时，主线程就会去读取"回调队列"里的事件，依次把那些事件所对应的回调函数压入栈中执行。然后再回到上一步。

![event loop image](/images/posts/2017-07-03/eventloop.png)